<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:si="http://www.springframework.org/schema/integration"
       xmlns:si-xml="http://www.springframework.org/schema/integration/xml"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
			http://www.springframework.org/schema/beans/spring-beans.xsd
			http://www.springframework.org/schema/integration
			http://www.springframework.org/schema/integration/spring-integration.xsd
			http://www.springframework.org/schema/integration/xml
            http://www.springframework.org/schema/integration/xml/spring-integration-xml.xsd">

    <bean id="legMarshaller" class="org.springframework.oxm.jaxb.Jaxb2Marshaller">
        <property name="classesToBeBound">
            <value>
                com.manning.siia.domain.trip.LegQuoteCommand
            </value>
        </property>
    </bean>

    <si:channel id="javaLegQuoteCommands"/>

    <si-xml:marshalling-transformer input-channel="javaLegQuoteCommands" output-channel="xmlLegQuotes"
                                    marshaller="legMarshaller" result-transformer="resultToDocumentTransformer"/>

    <bean id="resultToDocumentTransformer"
          class="org.springframework.integration.xml.transformer.ResultToDocumentTransformer"/>

    <si:channel id="xmlLegQuotes"/>

    <si-xml:xslt-transformer input-channel="xmlLegQuotes" output-channel="xslTransformedLegQuote"
                             xsl-resource="classpath:/xsl/enrichCriteriaWithLeg.xsl"/>

    <si:channel id="xslTransformedLegQuote"/>

    <si-xml:xpath-splitter create-documents="true" input-channel="xslTransformedLegQuote" output-channel="splitQuotes">
        <si-xml:xpath-expression expression="/legQuote/*"/>
    </si-xml:xpath-splitter>

    <si:channel id="splitQuotes"/>
    <si-xml:xpath-router id="quoteRequestRouter" input-channel="splitQuotes" 
                         channel-resolver="quoteChannelMap">
        <si-xml:xpath-expression expression="local-name(/*)"/>
    </si-xml:xpath-router>

    <bean id="quoteChannelMap" class="org.springframework.integration.channel.MapBasedChannelResolver">
        <property name="channelMap">
            <map>
                <entry key="carQuote" value-ref="carQuoteChannel"/>
                <entry key="flightQuote" value-ref="flightQuoteChannel"/>
                <entry key="hotelQuote" value-ref="hotelQuoteChannel"/>
            </map>
        </property>
    </bean>

    <si:channel id="carQuoteChannel">
        <si:queue/>
    </si:channel>


    <si:channel id="flightQuoteChannel" />
    <si-xml:validating-router id="flightQuoteValidator" input-channel="flightQuoteChannel"
                              valid-channel="validFlightQuoteChannel" invalid-channel="invalidRequests "
                              schema-location="classpath:xsd/flightQuote.xsd" />

    <si:channel id="validFlightQuoteChannel">
        <si:queue/>
    </si:channel>



    <si:channel id="hotelQuoteChannel">
        <si:queue/>
    </si:channel>


    <si:channel id="invalidRequests">
        <si:queue/>
    </si:channel>

</beans>